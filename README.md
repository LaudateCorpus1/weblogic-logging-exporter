# WebLogic Logging Exporter

The goal of this project is to provide an easy to configure, robust, and production-ready solution to access
WLS log information through Elasticsearch and Kibana.

The WebLogic Logging Exporter adds a log event handler to WebLogic Server,
such that WebLogic server logs can be integrated into [Elastic Stack](https://www.elastic.co/products)
in Kubernetes directly,  by using the [Elasticsearch](https://www.elastic.co/products/elasticsearch) REST API.

The current version of the WebLogic Logging Exporter is 0.1, which was released on March 20, 2019.
This version supports pushing logs into Elasticsearch using the REST API.

The following features are planned for the next few releases:

* Push logs into a fleuntd aggregator using the REST API,
* Write logs in JSON format into the file system so that they could be collected and published by a
  sidecar, e.g. fluentd or Logstash,
* Provide the ability to publish other logs (i.e. other than the server logs).

## Contents

* How to [download the release](#download-the-release)
* How to [build from source](#building-from-source)
* How to [install](#installation) the WebLogic Logging exporter
* How to [contribute](#contributing) to this project
* [License](#license) information


## Getting Started

These instructions outline the steps to build the `weblogic-logging-exporter.jar` file, which can then
be integrated into the [WebLogic Kubernetes Operator](https://github.com/oracle/weblogic-kubernetes-operator/)
for handling the server logs generated by the WebLogic Server domain.


## Download the release

You can download the WebLogic Logging Exporter already compiled for you from the
[releases page](https://github.com/oracle/weblogic-logging-exporter/releases).

## Building from source

If you prefer, you can build the WebLogic Logging Exporter from the source code.  To do this, you will
need access to some WebLogic Server libraries.  There are two ways to get these libraries:

* Populate you local Maven repository with the required files from a local WebLogic Server installation
  using the Oracle Maven Synchronization plugin, or
* Use the Oracle Maven repository to download them as part of your build, this requires registration and
  configuring your local Maven installation with the appropriate authentication details.

### Populating your local Maven repository from a local WebLogic Server installation

You can use the Oracle Maven Synchronization plugin, which is included in your WebLogic Server installation,
to install the necessary dependencies into your local Maven repository.

There are two steps:

* Install the Oracle Maven Synchronization plugin,
* Run the "push" goal to populate your local Maven repository from your WebLogic Server installation.

#### Installing the Oracle Maven Synchronization plugin

To install the plugin, navigate to your WebLogic Server installation then enter the commands (this example
assumes you installed WebLogic Server in /u01/wlshome):

```
cd /u01/wlshome/oracle_common/plugins/maven/com/oracle/12.2.1/oracle-maven-sync
mvn install:install-file -DpomFile=oracle-maven-sync-12.2.1.pom -Dfile=oracle-maven-sync-12.2.1.jar
```

#### Popoulating your local Maven repository

To populate your local Maven repository from your WebLogic Server installation, enter this command:

```
mvn com.oracle.maven:oracle-maven-sync:push -DoracleHome=/u01/wlshome
```

You can verify the dependencies were installed by looking in your local Maven repository which is
normally located at `~/.m2/repository/com/oracle/weblogic`.


### Using the Oracle Maven repository

Note: If you populated your local repository using the Oracle Maven Synchronization plugin, then this
step is *not* required.

To access the Oracle Maven repository, there are two requirements to be aware of:

1. You must be using [Maven 3.2.5](http://maven.apache.org/docs/3.2.5/release-notes.html) or later.
This contains the version of the [Wagon 2.8](http://maven.apache.org/wagon/) component that has
been enhanced to support access to artifacts that are protected by
[HTTP authentication schemes](https://issues.apache.org/jira/projects/WAGON/issues/WAGON-422).

2. You must be registered with OTN and have accepted the license agreement to access and use the
Oracle Maven Repository.  This can be done with either a new or an existing OTN user account by
accessing the http://maven.oracle.com site and selecting the registration link.
After registering, then you just need to configure your local Maven environment with the details
of the Oracle Maven Repository, including the information that relates to the authentication model
specifying your OTN user name and password.

#### Configure Maven

#### 1. Encrypt your OTN Password.

You need to configure Maven to use the Oracle Maven Repository. This involves telling Maven about the repository and providing the necessary information to authenticate to the repository.
The following steps show you how to save your OTN password in your `settings.xml` file so  that you do not have to specify it manually every time.
Oracle recommends that you encrypt your password, using the utilities provided with Maven.

Here are the steps to encrypt your password and save it in your settings.   For more information, refer to [Maven Password Encryption](http://maven.apache.org/guides/mini/guide-encryption.html).

```
mvn --encrypt-master-password my_master_password
```
The output will be a string similar to this:  

`{abcdefghijklmnopqrstuvwxyz123=}`

Save this value in your Maven `settings-security.xml` file.

A copy of your `~/.m2/settings-security.xml` file will look like this:
```
<settingsSecurity>
  <master>{abcdefghijklmnopqrstuvwxyz123=}</master>
</settingsSecurity>
```

Now that you have a master password defined, you can encrypt your OTN password using the following command:
```
mvn --encrypt-password my_OTN_password
```
The output will be another string that looks like this:  

`{==thisIs12My34_OTN_45_encrypted==}`

This will be the password that you provide in the `server` section of your `settings.xml` file when you configure the HTTP Wagon.  

#### 2. Add the Oracle Maven Repository to your `settings.xml` file.

Add a repository definition to your Maven `settings.xml` file. The repository definition should look like the following:

```
<profiles>
    <profile>
      <id>main</id>
      <activation>
        <activeByDefault>true</activeByDefault>
      </activation>
      <repositories>
        <repository>
          <id>maven.oracle.com</id>
          <url>https://maven.oracle.com</url>
          <layout>default</layout>
          <releases>
             <enabled>true</enabled>
          </releases>
        </repository>
      </repositories>

      <pluginRepositories>
        <pluginRepository>
          <id>maven.oracle.com</id>
          <url>https://maven.oracle.com</url>
        </pluginRepository>
      </pluginRepositories>
    </profile>
  </profiles>
```

The Maven `settings.xml` file requires additional settings to support the Oracle Maven Repository.
To configure the HTTP Wagon, add the following `<server>` element to the `<servers>` section of the Maven `settings.xml` file.
```
<servers>
    <server>
      <username>my_OTN_user_name</username>
      <password>{==thisIs12My34_OTN_45_encrypted==}</password>
      <configuration>
        <basicAuthScope>
          <host>ANY</host>
          <port>ANY</port>
          <realm>OAM 11g</realm>
        </basicAuthScope>
        <httpConfiguration>
          <all>
            <params>
              <property>
                <name>http.protocol.allow-circular-redirects</name>
                <value>%b,true</value>
              </property>
            </params>
          </all>
        </httpConfiguration>
      </configuration>
      <id>maven.oracle.com</id>
    </server>
  </servers>
```

If needed, specify the `proxies` that are required.

### Building the WebLogic Logging Exporter

To build the WebLogic Logging Exporter, simply clone the project from GitHub and then build it
with Maven:

```
git clone git@orahub.oraclecorp.com:oracle/wls-logging-exporter.git
mvn install
```

The `weblogic-logging-exporter-0.1.jar` will be available under the `target` directory.

## Installation

This section outlines the steps that are required to add the Weblogic Logging Exporter to Weblogic Server.

1. Download or build the WebLogic Logging Exporter as described above.

1. Copy the `weblogic-logging-exporter-0.1.jar` into a suitable location, e.g. into your domain directory.

1. Add a startup class to your domain configuration.

   * In the administration console, navigate to "Environment" then "Startup and Shutdown classes" in the main menu.
   * Add a new Startup class, you may choose any descriptive name, and the class name must be
     `weblogic.logging.exporter.Startup`.
   * Target the startup class to each server that you want to export logs from.

   You can verify this by checking for the update in your `config.xml` which should be similar to this example:

    ```
    <startup-class>
        <name>LoggingExporterStartupClass</name>
        <target>AdminServer</target>
        <class-name>weblogic.logging.exporter.Startup</class-name>
    </startup-class>
    ```

1. Add `weblogic-logging-exporter.jar` and `snakeyaml.jar` to your classpath

This project requires the YAML  parser  to parse the configuration file.   Thus you also need to add the
snakeyaml.jar to your class path.   If you have build the project yourself,  the jar should be available as
repository/org/yaml/snakeyaml/1.19/snakeyaml-1.19.jar,  or you can download that from
https://jar-download.com/artifacts/org.yaml/snakeyaml/1.19/source-code

You may want to create a file named "WebLogicLoggingExporter.yaml"  and put it under the config directory
of domain home. This is the default location.  Or you can specify a system variable named
"WEBLOGIC_LOGGING_EXPORTER_CONFIG_FILE" and have it pointed to the configuration file.
Refer to the later section for the content of this file.

Restart the domain,  the domain logs will be posted to ElasticSearch.   You can do the following curl
command to verify that domain logs has been posted to Elasticsearch.   The default index name is "wls",
and docs.count should be greater than 0 indicating that log entries is being sent to ElasticSearch.

```
$ curl "localhost:9200/_cat/indices?v"
health status index               uuid pri rep docs.count docs.deleted store.size pri.store.size
yellow open   wls                 q4Q2v2dXTBOyYsHZMdDe3H 5   1         23            0      101kb          101kb
```


## Contributing

Please read [CONTRIBUTING.md](CONTRIBUTING.md) for details on our code of conduct, and the process for submitting pull requests to us.


## License

This project is licensed under the [_Universal Permissive License, Version 1.0_](http://oss.oracle.com/licenses/upl)
